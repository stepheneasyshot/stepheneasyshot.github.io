---
layout: post
description: > 
  本文介绍了mqtt协议相关内容，背景知识和协议规范
image: 
  path: /assets/img/blog/blogs_mqtt_cover.png
  srcset: 
    1920w: /assets/img/blog/blogs_mqtt_cover.png
    960w:  /assets/img/blog/blogs_mqtt_cover.png
    480w:  /assets/img/blog/blogs_mqtt_cover.png
accent_image: /assets/img/blog/blogs_mqtt_cover.png
excerpt_separator: <!--more-->
sitemap: false
---
# 【网络】MQTT协议基础
## 背景

>MQTT是一个客户端服务端架构的发布/订阅模式的消息传输协议。它的设计思想是轻巧、开放、简单、规范，易于实现。这些特点使得它对很多场景来说都是很好的选择，特别是对于受限的环境如机器与机器的通信（M2M）以及物联网环境（IoT）。
——MQTT协议规范中文版

MQTT协议最初版本是在1999年建立的。该协议的发明人是的Andy Stanford-Clark和Arlen Nipper。

MQTT 的诞生，是在一个利用卫星通讯监控输油管道的项目。

所以它最初是面对低带宽、高延迟或不可靠的网络而设计的。虽然历经几十年的更新和变化，以上这些特点仍然是MQTT协议的核心特点。但是与最初不同的是，MQTT协议已经从嵌入式系统应用拓展到开放的物联网（IoT）领域。

## 版本
MQTT协议有三个版本，分别是：
* MQTT v3.1
* MQTT v3.1.1
* MQTT v5.0

目前客户端很多主流的MQTT库都是基于MQTT v3.1.1版本。而且后续的5.0是完全兼容3.1.1版本的，所以优先学习这个3.1.1版本。

## 基本通信介绍
和其他网络通信流程一致，MQTT通信中的角色也是分为服务端和客户端。

![cs](/assets/img/blog/blogs_mqtt_cs.jpg)

* 服务端是MQTT信息传输的枢纽，负责将MQTT客户端发送来的信息传递给MQTT客户端。MQTT服务端还负责管理MQTT客户端。确保客户端之间的通讯顺畅，保证MQTT消息得以正确接收和准确投递。
* 客户端可以往服务端推送消息和获取消息。

MQTT协议的通信架构是独特的 **订阅发布机制** ，不像HTTP那种请求响应机制，从服务端获取数据需要客户端主动发起请求，服务端才能返回数据。

MQTT的通信机制更像是Android里的广播，客户端可以订阅某个主题，当服务端发现这个主题被某一个客户端发布更新时，就会将消息推送给订阅了该主题的客户端。

### 订阅发布机制
MQTT服务端在管理MQTT信息通讯时，就是使用一个个的“主题”来控制的。

比如车载云平台开发时，就会有一个 **车辆状态** 的主题，当车辆状态发生变化时，就会往这个 **车辆状态** 主题发送消息。具体的，当汽车的胎压传感器有数据上报时，就会往“胎压传感器”这个主题发送消息。手机客户端，订阅了这个胎压主题，就可以收到胎压传感器上报到服务器，而后分发下来的消息。

![mqtt](/assets/img/blog/blogs_mqtt_tyer_pressure.png)

同时，手机端可以往 **座椅加热** 这个主题发布消息，打开开关。服务器收到消息后，就会下发到订阅这个主题的汽车客户端，车辆控制器收到后就可以远程打开座椅加热。在冬天，司机上车之前就可以提前打开座椅加热，上车之后就不会被冻了。

![mqtt](/assets/img/blog/blogs_mqtt_setaheat.png)

### 订阅发布的特性
从以上实例我们可以看到，MQTT通讯的核心枢纽是MQTT服务端。有了服务端对MQTT信息的接收、储存、处理和发送，客户端在发布和订阅信息时，可以相互独立，且在空间上可以分离，时间上可以异步。

#### 相互可独立
MQTT客户端是一个个独立的个体。它们无需了解彼此的存在，依然可以实现信息交流。客户端本身可以完全不知道有多少个MQTT客户端订阅了这一主题。而订阅了同一主题的客户端也完全不知道彼此的存在。大家只要订阅了同一个主题，MQTT服务端就会在每次收到新信息时，将信息发送给订阅的客户端。
#### 空间可分离
空间分离相对容易理解，MQTT客户端在通讯必要条件是连接到了同一个MQTT通讯网络。这个网络可以是互联网或者局域网。只要客户端联网，无论他们远在天边还是近在眼前，都可以实现彼此间的通讯交流。
#### 时间可异步
MQTT客户端在**发送和接收信息时无需同步**。这一特点对物联网设备尤为重要。有时物联网设备会发生意外离线的情况。当我们的汽车在行驶过程中，可能会突然进入隧道，这时汽车可能会断开与MQTT服务端的连接。假设在此时我们的手机客户端向汽车客户端所订阅的“空调温度”主题发布了信息，而汽车恰恰不在线。这时，MQTT服务端可以将“空调温度”主题的新信息保存，待汽车再次上线后，服务端再将“空调温度”信息推送给汽车。


## 连接服务器

首先MQTT客户端将会向服务端发送连接请求。该请求实际上是一个包含有连接请求信息的数据包。这个数据包的官方名称为CONNECT。

MQTT服务端收到客户端连接请求后，会向客户端发送连接确认。同样的，该确认也是一个数据包。这个数据包官方名称为CONNACK。

### 用户密码认证


## 发布，订阅，取消订阅

* PUBLISH – 发布信息
* SUBSCRIBE – 订阅主题
* SUBACK – 订阅确认
* UNSUBSCRIBE – 取消订阅

### 主题进阶

## QoS服务质量

MQTT协议有三种服务质量级别：

QoS = 0 – 最多发一次
QoS = 1 – 最少发一次
QoS = 2 – 保证收一次

以上三种不同的服务质量级别意味着不同的MQTT传输流程。对于较为重要的MQTT消息，我们通常会选择QoS>0的服务级别（即QoS 为1或2）。

## 保留消息


## 心跳机制

## 遗嘱消息

## 
