---
layout: post
description: > 
  本文介绍了Android平台上连接手环等BLE设备一般的通信流程
image: 
  path: /assets/img/blog/blogs_ble_cover.png
  srcset: 
    1920w: /assets/img/blog/blogs_ble_cover.png
    960w:  /assets/img/blog/blogs_ble_cover.png
    480w:  /assets/img/blog/blogs_ble_cover.png
accent_image: /assets/img/blog/blogs_ble_cover.png
excerpt_separator: <!--more-->
sitemap: false
---
# 【Android进阶】BLE通信一般流程
核心概念先行
* 手机 (Central / 中心设备)： 主动扫描并连接其他设备的设备，在BLE协议中称为 **中心设备** 。手机、电脑等通常扮演这个角色。
* BLE设备 (Peripheral / 外围设备)： 被动广播自身信息，等待被连接的设备，称为外围设备。如智能手环、心率带、防丢器等。
* GATT (Generic Attribute Profile)： 这是连接建立后，双方通信所遵循的核心协议。它定义了一个 **服务-特征值** 的数据结构。
    * 服务： 一个独立的功能模块。例如，一个“心率服务”。
    * 特征： 服务下的具体数据点。它是实际读写操作的对象。例如，在“心率服务”下，会有 **“心率测量特征”** （用于读取心率数据）和 **“心率位置特征”** （用于写入或通知佩戴位置）。
    * 属性： 特征、服务等都被称为属性，每个属性都有一个唯一的标识符。

## 1. 寻找设备 广播与扫描
这个阶段的目标是让手机发现BLE设备的存在
### 外围设备广播
外围设备会周期性地（例如每秒100次）向周围环境 **发送广播数据包**（Advertising Packets）。这些数据包包含少量信息，这就是广播报文。

广播报文内容：
* 设备地址： 类似MAC地址，是设备的唯一标识符。
* 设备名称： 可读的名称，如 “MI_Band”。
* 发射功率： 用于粗略的距离估算。
* 服务UUIDs： 设备所支持的主要服务的列表。这是手机判断设备类型的关键（例如，看到“心率服务”的UUID，就知道这是个心率设备）。
* 制造商特定数据： 设备厂商可以自定义放入一些数据，如电池电量、硬件版本等。

有几种广播类型，最常见的是 **可连接**（Connectable）的广播，表示设备愿意接受连接请求。

### 中心设备扫描
手机（通常作为中央设备 Central）处于**扫描**状态，App通过操作系统提供的蓝牙API启动蓝牙扫描，手机的蓝牙芯片会监听来自周围 BLE 设备的广播数据包，在同样的广播通道上监听这些广播报文。

手机收到数据包后，会将其解析并**回调**给应用程序，提取出上述广播的信息，并在App的扫描结果列表中显示出来（例如，显示“发现设备：MI_Band”）。

此时，手机知道了BLE设备的存在和基本信息，但双方还未建立正式连接。
这是设备间建立联系的第一步。

## 2. 建立连接
当用户在手机 App 上选择一个设备后，就会开始连接过程。

手机请求：
* **动作:** 手机 App 调用系统 API，向选定的 BLE 设备**发送连接请求**（Connection Request）。
* **信息:** 请求中会包含**连接参数**，如连接间隔（Connection Interval）、从机延迟（Slave Latency）和超时时间（Supervision Timeout），这些参数定义了连接后数据交换的频率和容错能力。即双方会协商一套通信参数，如连接间隔（设备多久通信一次，影响功耗和响应速度）、从机延迟等。

BLE 设备响应：
* **动作:** BLE 设备从广播状态切换到**连接**状态，并**接受**连接请求。
* **结果:** 双方建立了一个**双向的、独占的**连接。从此刻起，设备停止广播，并且只有这个手机能与它通信。双方进入**链路层**（Link Layer）的数据交换阶段。在连接状态下，通信会从之前的3个广播通道切换到37个数据通道，并通过一种自适应跳频技术来避免无线干扰，保证通信稳定。

## 3. 服务发现
连接建立后，手机需要知道设备上有什么功能。BLE 使用 **GATT (Generic Attribute Profile)** 规范来组织数据。数据被组织成服务和特性，每个特性都有一个 **UUID** 标识。

手机会自动向BLE设备发送一个 **“服务发现请求”** 。

BLE设备会将其内部的所有服务，以及每个服务下的所有特征，像一个文件目录一样完整地返回给手机。

手机端的蓝牙协议栈会解析这个“目录”，并建立一个本地的GATT数据库。此后，App就可以通过查询这个数据库来知道可以对设备进行哪些操作。

### 3.2 发现过程 - 手机

* **动作:** 手机（作为 **GATT 客户端**）发起**服务发现**请求。
* **通信:** 手机依次读取 BLE 设备（作为 **GATT 服务器**）上的所有**服务**，然后读取每个服务下的所有**特性**。
* **结果:** 手机 App 知道了设备的全部功能结构（UUID 和属性）。

---

## 4. 校验与安全 (Bonding & Security)

安全性和配对通常发生在服务发现之后，或在第一次读写受保护的特性时触发。

### 4.1 配对/绑定 (Bonding/Pairing)

* **目的:** 建立**信任**关系，并交换**安全密钥**，以便在后续连接中能进行**加密通信**。
* **触发:** 当手机尝试访问需要**安全级别**（如加密、身份验证）的特性时，系统会自动触发配对流程。
* **校验流程:**
    1.  **特性交换 (Feature Exchange):** 双方协商安全级别和配对方式（如 **Just Works**、**Passkey Entry**、**Numeric Comparison** 等）。
    2.  **身份验证 (Authentication):** 根据协商的方式，可能需要用户**输入或确认配对码**。
    3.  **密钥分发 (Key Distribution):** 配对成功后，双方交换**长期密钥 (LTK)**，并将其存储起来（称为**绑定**）。
* **后续:** 绑定后，后续连接可以直接使用 LTK 建立加密链路，无需重复配对。

---

## 5. 通信与数据交换 (Data Exchange)

这是实际进行数据交互的阶段。

### 5.1 数据读写 (Read & Write) - 手机主动

* **读取 (Read):** 手机向 BLE 设备发送**读取特性值**的请求，用于获取当前状态（例如，读取一次当前的电池电量）。
* **写入 (Write):** 手机向 BLE 设备发送**写入特性值**的请求，用于发送控制命令或配置参数（例如，向设备发送一个“开始测量”的命令）。

### 5.2 通知与指示 (Notify & Indicate) - BLE 设备主动

* **目的:** 允许 BLE 设备在数据发生变化时**主动**向手机发送数据，无需手机不断轮询。
* **启用:** 手机需要先向特性写入一个特定的描述符（**Client Characteristic Configuration Descriptor - CCCD**）来**启用**通知或指示。
* **通知 (Notify):** 设备向手机发送数据，手机**不发送确认**（更快、更低功耗）。常用于实时数据流（如心率）。
* **指示 (Indicate):** 设备向手机发送数据，要求手机**必须返回一个确认**（更可靠，但速度略慢）。

---

## 流程总结

| 环节 | 手机动作 (Central) | BLE 设备动作 (Peripheral) | 目标/状态 |
| :--- | :--- | :--- | :--- |
| **寻找** | 扫描 (Scanning) | 广播 (Advertising) | 手机发现周围的设备。 |
| **连接** | 发送连接请求 | 接受连接请求 | 建立独占的**双向连接**。 |
| **发现** | 读服务和特性 | 提供 GATT 服务/特性 | 手机了解设备的功能结构。 |
| **校验** | 触发配对流程 | 配合完成配对 | 建立**安全加密链路**（可选）。 |
| **通信** | 读/写数据，启用通知 | 响应读/写，发送通知 | 进行**实时的数据交换**。 |

---

这个流程是所有基于 BLE 的应用通信的基础。作为一名 Android 开发者，你可以在 Android 的 `BluetoothLeScanner` 类中找到扫描相关的 API，在 `BluetoothGatt` 类中找到连接、服务发现和数据读写相关的 API。