---
layout: post
description: > 
  æœ¬æ–‡ä»‹ç»äº†Jetpack Composeä¸­ä¸€ç³»åˆ—åŠ¨ç”»APIçš„ä½¿ç”¨
image: 
  path: /assets/img/blog/blogs_compose_cover.png
  srcset: 
    1920w: /assets/img/blog/blogs_compose_cover.png
    960w:  /assets/img/blog/blogs_compose_cover.png
    480w:  /assets/img/blog/blogs_compose_cover.png
accent_image: /assets/img/blog/blogs_compose_cover.png
excerpt_separator: <!--more-->
sitemap: false
---
# Composeä¸­çš„åŠ¨ç”»
### å‡ºç°æ¶ˆå¤±åŠ¨ç”»
**AnimatedVisibility** æ˜¯Jetpack Composeä¸­ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„åŠ¨ç”»APIï¼Œå®ƒå¯ä»¥è®©æˆ‘ä»¬åœ¨Composableå‡½æ•°ä¸­å®ç°å…ƒç´ çš„å‡ºç°å’Œæ¶ˆå¤±åŠ¨ç”»ã€‚å®ƒçš„ä½¿ç”¨éå¸¸ç®€å•ï¼Œåªéœ€è¦åœ¨éœ€è¦æ·»åŠ åŠ¨ç”»æ•ˆæœçš„å…ƒç´ ä¸Šä½¿ç”¨AnimatedVisibilityå³å¯ã€‚

AnimatedVisibility çš„æ–¹æ³•ç­¾åå¦‚ä¸‹ï¼š

```kotlin
@Composable
fun ColumnScope.AnimatedVisibility(
    visible: Boolean,
    modifier: Modifier = Modifier,
    enter: EnterTransition = fadeIn() + expandVertically(),
    exit: ExitTransition = fadeOut() + shrinkVertically(),
    label: String = "AnimatedVisibility",
    content: @Composable AnimatedVisibilityScope.() -> Unit
) {
    val transition = updateTransition(visible, label)
    AnimatedVisibilityImpl(transition, { it }, modifier, enter, exit, content = content)
}
```

> visibleæ˜¯ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œç”¨äºæ§åˆ¶å…ƒç´ çš„å‡ºç°å’Œæ¶ˆå¤±ã€‚
modifieræ˜¯ä¸€ä¸ªModifierå¯¹è±¡ï¼Œç”¨äºä¿®æ”¹å…ƒç´ çš„å¤–è§‚ã€‚
enteræ˜¯ä¸€ä¸ªEnterTransitionå¯¹è±¡ï¼Œç”¨äºæ§åˆ¶å…ƒç´ å‡ºç°æ—¶çš„åŠ¨ç”»æ•ˆæœã€‚
exitæ˜¯ä¸€ä¸ªExitTransitionå¯¹è±¡ï¼Œç”¨äºæ§åˆ¶å…ƒç´ æ¶ˆå¤±æ—¶çš„åŠ¨ç”»æ•ˆæœã€‚
labelæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œç”¨äºæ ‡è¯†å…ƒç´ ã€‚
contentæ˜¯ä¸€ä¸ªComposableå‡½æ•°ï¼Œç”¨äºå®šä¹‰å…ƒç´ çš„å†…å®¹ã€‚

ä¸¾ä¾‹ï¼Œè®¾ç½®ä¸¤ä¸ªtextï¼Œä¸Šé¢é‚£ä¸ªtextç‚¹å‡»åå¼€å§‹é€€åœºï¼Œ2såé‡æ–°å‡ºç°ã€‚

![](/assets/img/blog/blogs_compose_anim_visibility.png){:width="300" height="200" loading="lazy"}

æºç å¦‚ä¸‹ï¼š

```kotlin
@Composable
fun AnimatedVisibilityDemo() {
    Column(modifier = Modifier.width(IntrinsicSize.Max)) {

        val scope = rememberCoroutineScope()

        val isShow = remember { mutableStateOf(true) }

        AnimatedVisibility(visible = isShow.value) {
            Text(
                text = "How are you?",
                color = Color.White,
                modifier = Modifier
                    .fillMaxWidth(1f)
                    .background(Color.Red)
                    .clip(RoundedCornerShape(10))
                    .clickable {
                        isShow.value = false // ç‚¹å‡»åæ¶ˆå¤±
                        scope.launch {
                            delay(2000)
                            isShow.value = true // 2ç§’åé‡æ–°å‡ºç°
                        }
                    }
                    .padding(20.dp)
            )
        }

        Text(
            text = "I'm fine, thank you! And you?",
            color = Color.White,
            modifier = Modifier
                .fillMaxWidth(1f)
                .background(Color.Blue)
                .clip(RoundedCornerShape(10))
                .padding(20.dp)
        )
    }
}
```

å¯ä»¥çœ‹åˆ° Compose ä¸ºäº†ç®€åŒ–ä½¿ç”¨ï¼Œå·²ç»é¢„è®¾äº†è¿›å‡ºåœºçš„åŠ¨ç”»ï¼Œè¿›åœºæ˜¯fadeIn() + expandVertically()ï¼Œå‡ºåœºæ˜¯fadeOut() + shrinkVertically()ã€‚å¦‚æœéœ€è¦è‡ªå®šä¹‰åŠ¨ç”»æ•ˆæœï¼Œå¯ä»¥æ‰‹åŠ¨å£°æ˜å¹¶ä¼ å…¥ AnimatedVisibility çš„enterå’Œexitå‚æ•°ã€‚enterå‚æ•°æ˜¯ä¸€ä¸ªEnterTransitionå¯¹è±¡ï¼Œç”¨äºæ§åˆ¶å…ƒç´ å‡ºç°æ—¶çš„åŠ¨ç”»æ•ˆæœã€‚

å¯ä»¥åƒå®˜æ–¹ä¾‹ç¨‹é‡Œé‚£æ ·ï¼Œè‡ªå®šä¹‰è¿™ä¸¤ä¸ªå‚æ•°ä¼ å…¥ï¼š

```kotlin
AnimatedVisibility(visible = isShow.value,
            enter = slideInVertically {
                // Slide in from 40 dp from the top.
                with(density) { -40.dp.roundToPx() }
            } + expandVertically(
                // Expand from the top.
                expandFrom = Alignment.Top
            ) + fadeIn(
                // Fade in with the initial alpha of 0.3f.
                initialAlpha = 0.3f
            ),
            exit = slideOutVertically() + shrinkVertically() + fadeOut()) {

}
```

è¿›åœºå‚æ•°è‡ªå®šä¹‰ï¼Œè®¾å®šä»¥topä¸ºåŸºå‡†ï¼Œæ‰©å¼ çš„æ—¶å€™ä»ä¸Šå¾€ä¸‹ï¼Œæ»‘åŠ¨çš„æ—¶å€™ä»ä¸Šå¾€ä¸‹ã€‚

#### æ›´æ”¹åŠ¨ç”»æ—¶é•¿
AnimatedVisibility ä¸­çš„åŠ¨ç”»æ—¶é•¿å¯ä»¥é€šè¿‡ä¿®æ”¹ enter å’Œ exit ä¸­çš„åŠ¨ç”»å‚æ•°æ¥æ§åˆ¶ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ fadeIn() åŠ¨ç”»ï¼Œå¹¶å°†æŒç»­æ—¶é—´è®¾ç½®ä¸º 2 ç§’ï¼š

```kotlin
AnimatedVisibility(
    visible = isShow.value,
    enter = fadeIn(
        animationSpec = tween(2000)
    ),
    exit = fadeOut(
        animationSpec = tween(2000)
    )
)
```

#### ä½¿ç”¨MutableTransitionStateæ§åˆ¶åŠ¨ç”»
AnimatedVisibility è¿˜å¯ä»¥ä½¿ç”¨ MutableTransitionState æ¥æ§åˆ¶åŠ¨ç”»ã€‚MutableTransitionState æ˜¯ä¸€ä¸ªå¯å˜çš„ TransitionStateï¼Œå®ƒå¯ä»¥åœ¨è¿è¡Œæ—¶æ›´æ”¹å…¶ç›®æ ‡çŠ¶æ€ã€‚é€šå¸¸å¯ä»¥ç”¨ä½œåœ¨ä¸€å¼€å§‹å°±è§¦å‘åŠ¨ç”»ï¼Œè¿˜å¯ä»¥å®æ—¶åœ° **è§‚å¯Ÿåˆ°åŠ¨ç”»çŠ¶æ€** ã€‚

```kotlin
@Composable
fun AnimatedVisibilityDemo() {
    Column(modifier = Modifier.width(IntrinsicSize.Max)) {

        val scope = rememberCoroutineScope()

        val state = remember {
            MutableTransitionState(false).apply {
                // Start the animation immediately.
                targetState = true
            }
        }

        AnimatedVisibility(visibleState = state) {
            Text(
                text = "How are you?",
                color = Color.White,
                modifier = Modifier
                    .fillMaxWidth(1f)
                    .background(Color.Red)
                    .clip(RoundedCornerShape(10))
                    .clickable {
                        state.targetState = !state.targetState
                        scope.launch {
                            delay(2000)
                            state.targetState = !state.targetState
                        }
                    }
                    .padding(20.dp)
            )
        }

        Text(
            text = when {
                state.isIdle && state.currentState -> "Visible"
                !state.isIdle && state.currentState -> "Disappearing"
                state.isIdle && !state.currentState -> "Invisible"
                else -> "Appearing"
            },
            color = Color.White,
            modifier = Modifier
                .fillMaxWidth(1f)
                .background(Color.Blue)
                .clip(RoundedCornerShape(10))
                .padding(20.dp)
        )
    }
}
```

è§‚å¯Ÿæ•ˆæœï¼š

![](/assets/img/blog/blogs_compose_anim_state_listen.png){:width="300" height="200" loading="lazy"}

#### ç»™å­é¡¹æ·»åŠ åŠ¨ç”»
æœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦ç»™å­é¡¹å•ç‹¬æ·»åŠ åŠ¨ç”»ï¼Œä»¥è·å¾—æ›´çµæ´»çš„æ•ˆæœã€‚AnimatedVisibility é‡Œé¢çš„å­é¡¹å¯ä»¥ä½¿ç”¨  animateEnterExit ä¿®é¥°ç¬¦ï¼Œæ¥æ·»åŠ æ›´ç²¾ç»†çš„åŠ¨ç”»æ•ˆæœã€‚

```kotlin
    AnimatedVisibility(
        visible = isShow.value,
        enter = EnterTransition.None,
        exit = ExitTransition.None
    ) {
        Text(
            text = "How are you?",
            color = Color.White,
            modifier = Modifier
                .fillMaxWidth(1f)
                .animateEnterExit(
                    // Slide in/out the inner box.
                    enter = slideInVertically(),
                    exit = slideOutVertically()
                )
                .background(Color.Red)
                .clip(RoundedCornerShape(10))
                .clickable {
                    isShow.value = false // ç‚¹å‡»åæ¶ˆå¤±
                    scope.launch {
                        delay(2000)
                        isShow.value = true // 2ç§’åé‡æ–°å‡ºç°
                    }
                }
                .padding(20.dp)
        )
    }
```

éœ€è¦æ³¨æ„çš„æ˜¯AnimatedVisibilityå’Œå…¶å­é¡¹è®¾ç½®çš„åŠ¨ç”»æ•ˆæœæ˜¯å åŠ çš„ï¼Œæˆ‘ä»¬å¦‚æœä¸æƒ³è¦å¤–é¢çˆ¶ğŸ¤”è‡ªå¸¦çš„åŠ¨ç”»æ•ˆæœï¼Œå¯ä»¥æ˜¾ç¤ºçš„ä¼ å…¥EnterTransition.Nonehå’ŒExitTransition.Noneã€‚

#### æ·»åŠ è‡ªå®šä¹‰åŠ¨ç”»
é€šè¿‡ AnimatedVisibility çš„å†…å®¹ lambda å†…çš„ `transition` å±æ€§è®¿é—®åº•å±‚ Transition å®ä¾‹ã€‚æ·»åŠ åˆ° Transition å®ä¾‹çš„æ‰€æœ‰åŠ¨ç”»çŠ¶æ€éƒ½å°†ä¸ AnimatedVisibility çš„è¿›å…¥å’Œé€€å‡ºåŠ¨ç”»åŒæ—¶è¿è¡Œã€‚AnimatedVisibility ä¼šç­‰åˆ° Transition ä¸­çš„æ‰€æœ‰åŠ¨ç”»éƒ½å®Œæˆåå†ç§»é™¤å…¶å†…å®¹ã€‚å¯¹äºç‹¬ç«‹äº Transitionï¼ˆä¾‹å¦‚ä½¿ç”¨ animate*AsStateï¼‰åˆ›å»ºçš„é€€å‡ºåŠ¨ç”»ï¼ŒAnimatedVisibility å°†æ— æ³•è§£é‡Šè¿™äº›åŠ¨ç”»ï¼Œå› æ­¤å¯èƒ½ä¼šåœ¨å®Œæˆä¹‹å‰ç§»é™¤å†…å®¹å¯ç»„åˆé¡¹ã€‚

ä¾‹å¦‚åœ¨åŸæœ‰è¿›åœºåŠ¨ç”»çš„åŸºç¡€ä¸Šï¼Œæ·»åŠ ä¸€ä¸ªé¢œè‰²çš„åŠ¨ç”»ï¼š
```kotlin
 AnimatedVisibility(
) {
     val background by transition.animateColor(label = "color") { state ->
        if (state == EnterExitState.Visible) Color.Blue else Color.Gray
    }
        Text(
            text = "How are you?",
            color = Color.White,
            modifier = Modifier
               .fillMaxWidth(1f)
               .background(background)
               .clip(RoundedCornerShape(10))
        )
    }
```

#### ä½¿ç”¨ Crossfade åœ¨ä¸¤ä¸ªå¸ƒå±€ä¹‹é—´æ·»åŠ åŠ¨ç”»æ•ˆæœ
Crossfade å¯ä½¿ç”¨æ·¡å…¥æ·¡å‡ºåŠ¨ç”»åœ¨ä¸¤ä¸ªå¸ƒå±€ä¹‹é—´æ·»åŠ åŠ¨ç”»æ•ˆæœã€‚é€šè¿‡åˆ‡æ¢ä¼ é€’ç»™ current å‚æ•°çš„å€¼ï¼Œå¯ä»¥ä½¿ç”¨æ·¡å…¥æ·¡å‡ºåŠ¨ç”»æ¥åˆ‡æ¢å†…å®¹ã€‚

```kotlin
var currentPage by remember { mutableStateOf("A") }
Crossfade(targetState = currentPage, label = "cross fade") { screen ->
    when (screen) {
        "A" -> Text("Page A")
        "B" -> Text("Page B")
    }
}
```

### å°ºå¯¸æ”¹å˜åŠ¨ç”»
ä½¿ç”¨ `animateContentSize` ä¿®é¥°ç¬¦å¯ä»¥è®©Composableå‡½æ•°åœ¨å¤§å°å‘ç”Ÿå˜åŒ–æ—¶è¿›è¡ŒåŠ¨ç”»æ•ˆæœã€‚æ³¨æ„éœ€è¦æ·»åŠ åœ¨ä»»ä½•å°ºå¯¸ä¿®é¥°ç¬¦ä¹‹å‰ï¼Œä»¥é˜²æ­¢åŠ¨ç”»æ•ˆæœè¢«é”™è¯¯åœ°åº”ç”¨ã€‚

```kotlin
@Composable
fun AnimatedVisibilityDemo() {
    Column(modifier = Modifier.width(IntrinsicSize.Max)) {

        val scope = rememberCoroutineScope()

        var state by remember { mutableStateOf(false) }

        Text(
            text = "How are you?",
            color = Color.White,
            modifier = Modifier
                .animateContentSize()
                .fillMaxWidth(1f)
                .height(if (state) 160.dp else 80.dp)
                .background(Color.Red)
                .clip(RoundedCornerShape(10))
                .clickable {
                    state = true
                    scope.launch {
                        delay(2000)
                        state = false
                    }
                }
                .padding(20.dp)
        )

        Text(
            text = "I am fine.",
            color = Color.White,
            modifier = Modifier
                .fillMaxWidth(1f)
                .background(Color.Blue)
                .clip(RoundedCornerShape(10))
                .padding(20.dp)
        )
    }
}
```

### åˆ—è¡¨é¡¹åŠ¨ç”»
ä¸ºåˆ—è¡¨çš„æ¯ä¸ªé¡¹æ·»åŠ åŠ¨ç”»æ•ˆæœï¼Œä½¿ç”¨ `animateItem` ä¿®é¥°ç¬¦ã€‚

```kotlin
@Composable
fun ListItemAnimateDemo() {
    val listState = remember { mutableStateListOf<ListItem>() }

    LaunchedEffect(Unit) {
        repeat(10) {
            listState.add(ListItem(it, "Item $it"))
            delay(1000)
        }
        delay(1000)
        listState.removeAt(5)
    }

    LazyColumn(modifier = Modifier.fillMaxSize()) {
        items(listState, key = { it.id }) { item ->
            Text(
                text = item.title,
                color = Color.White,
                modifier = Modifier
                    .fillMaxWidth(1f)
                    .animateItem()
                    .background(Color.Blue)
                    .clip(RoundedCornerShape(10))
            )
        }
    }
}

data class ListItem(
    val id: Int,
    val title: String,
)
```

## è¿›åº¦
https://developer.android.google.cn/develop/ui/compose/animation/value-based?hl=zh-cn