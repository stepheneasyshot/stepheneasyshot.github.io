---
layout: post
description: > 
  本文介绍Kotlin协程挂起和恢复的原理
image: 
  path: /assets/img/blog/blogs_kotlin_cover2.png
  srcset: 
    1920w: /assets/img/blog/blogs_kotlin_cover2.png
    960w:  /assets/img/blog/blogs_kotlin_cover2.png
    480w:  /assets/img/blog/blogs_kotlin_cover2.png
accent_image: /assets/img/blog/blogs_kotlin_cover2.png
excerpt_separator: <!--more-->
sitemap: false
---
# Kotlin协程挂起和恢复的原理
## 协程简介
协程是一种并发设计模式，您可以在 Android 平台上使用它来简化异步执行的代码。协程 是在 1.3 版中添加到 Kotlin 的，基于既定的从其他语言转换成的概念。

在 `Android` 上，协程有助于管理长时间运行的任务，如果管理不当，这些任务可能会阻塞主线程并导致应用无响应。使用协程的专业开发者中有超过 50% 的人反映使用协程提高了工作效率。本主题介绍如何使用 `Kotlin` 协程解决以下问题，从而让您能够编写出更清晰、更简洁的应用代码。

### 四个基础概念
* suspend function。即挂起函数，delay() 就是协程库提供的一个用于实现非阻塞式延时的挂起函数
* CoroutineScope。即协程作用域，GlobalScope 是 CoroutineScope 的一个实现类，用于指定协程的作用范围，可用于管理多个协程的生命周期，所有协程都需要通过 CoroutineScope 来启动
* CoroutineContext。即协程上下文，包含多种类型的配置参数。Dispatchers.IO 就是 CoroutineContext 这个抽象概念的一种实现，用于指定协程的运行载体，即用于指定协程要运行在哪类线程上
* CoroutineBuilder。即协程构建器，协程在 CoroutineScope 的上下文中通过 launch、async 等协程构建器来进行声明并启动。launch、async 均被声明为 CoroutineScope 的扩展方法

### Android使用步骤
在Android平台使用协程，首先需要引入协程库：在项目的build.gradle.kts文件中添加以下依赖：

```kotlin
dependencies {
    implementation("org.jetbrains.kotlinx:kotlinx-coroutines-android:1.3.9")
}
```

创建协程：使用`coroutineScope`或`GlobalScope`来创建一个协程。同时android也提供了不同的协程作用域，如`viewModelScope`、`lifecycleScope`等。可以感知生命周期变化，自动取消，自动执行等。

```kotlin
// Create a coroutine scope
val coroutineScope = CoroutineScope(Dispatchers.Main)
// Create a coroutine
coroutineScope.launch {
    // Do some asynchronous work
    val result = withContext(Dispatchers.IO) {
        // Perform some long-running operation
        // ...
    }
    // Update the UI with the result
    // ...
}
```

执行异步操作：使用 `withContext` 可以切换作用域，可以理解成性质不同的线程。

```kotlin
// Execute an asynchronous operation
val result = withContext(Dispatchers.IO) {
    // Perform some long-running operation
    //...
}
```

处理结果：使用async和await来处理协程的结果。

```kotlin
// Handle the result of an asynchronous operation
val result = async {
    // Perform some asynchronous operation
    //...
}
// Wait for the result
val resultValue = result.await()
```

取消协程：使用`cancel`来取消一个协程。

```kotlin
// Cancel a coroutine
coroutineScope.cancel()
```

### 实际项目使用实例
最常见的使用方式，在 `ViewModel` 或者 `Controller` 里写业务逻辑，在 `Activity` 里调用，这样就可以在IO线程执行网络请求，拿到结果后自动切换到主线程更新UI。

```kotlin
// viewModel或者controller里获取数据逻辑
// 使用suspend限制在协程里使用；withContext切换调度器，指定在IO线程执行下面的任务
suspend fun getUserName() = withContext(Dispatchers.IO) {
    debugLog("thread name: ${Thread.currentThread().name}")
    ServiceCreator.createService<UserService>()
        .getUserName("2cd1e3c5ee3cda5a")
        .execute()
        .body()
}

// Activity调用处
override fun onCreate(savedInstanceState: Bundle?){
    // 最直接的声明方法，在主线程执行下面的逻辑
    lifeCycleScope.launch {
        // 相当于get这一半是在IO线程执行
        //拿到结果后的变量赋值这一半操作由调度器自动切换到主线程来执行了
        val userName = mViewModel.getUserName()
        infoLog("userName: $userName")
        binding.tvUserName.text = userName
    }
}
```

## 协程的实现原理
Kotlin 协程的 **挂起和恢复** 是其核心机制，理解这一机制有助于更好地使用协程。

### 1. 挂起函数（Suspending Functions）
挂起函数是协程的关键，使用 `suspend` 关键字标记。挂起函数可以在不阻塞线程的情况下暂停协程的执行，并在适当时候恢复。

```kotlin
suspend fun fetchData(): String {
    // 模拟耗时操作
    delay(1000)
    return "Data"
}
```

### 2. 挂起原理
挂起函数通过 `Continuation` 实现挂起和恢复。`Continuation` 是一个回调接口，用于在挂起后恢复执行。

```kotlin
interface Continuation<in T> {
    val context: CoroutineContext
    fun resumeWith(result: Result<T>)
}
```

- **挂起**：协程执行到挂起点时，保存当前状态（局部变量、执行位置等），并返回一个特殊值 `COROUTINE_SUSPENDED`，表示协程已挂起。
- **恢复**：当挂起操作完成后，通过 `Continuation.resumeWith` 恢复协程的执行。

### 3. 状态机
Kotlin 编译器将挂起函数转换为状态机， **每个挂起点对应一个状态** 。协程挂起时，保存当前状态；恢复时，根据状态继续执行。

```kotlin
suspend fun fetchData(): String {
    // 状态 0
    delay(1000)
    // 状态 1
    return "Data"
}
```

### 4. 调度器
协程的挂起和恢复由调度器（如 `Dispatchers.IO`、`Dispatchers.Main`）管理。调度器决定协程在哪个线程上执行和恢复。

### 5. 示例
以下代码展示了挂起和恢复的过程：

```kotlin
suspend fun fetchData(): String {
    delay(1000)
    return "Data"
}

fun main() = runBlocking {
    val result = fetchData()
    println(result)
}
```

- `runBlocking` 启动一个协程。
- `fetchData` 挂起协程 1 秒。
- 1 秒后，`fetchData` 恢复执行并返回结果。

### 6. 总结
Kotlin 协程通过挂起函数和 `Continuation` 实现挂起和恢复，编译器生成的状态机管理执行流程，调度器控制线程切换。这种机制使得协程高效且易于使用。